# Инструкция по тестированию Twin Tasters

## Краткое описание

"Близнецы вкуса" (Twin Tasters) - это функция, которая находит других пользователей с похожим профилем предпочтений фильмов на основе анализа:
- Жанровых предпочтений (cosine similarity)
- Оценок общих фильмов (Pearson correlation)  
- Любимых актеров и режиссеров (Jaccard similarity)

## Пошаговое тестирование

### 1. Запуск dev сервера
```bash
npm run dev
```

### 2. Перейти на страницу карты вкуса
```
http://localhost:3000/profile/taste-map
```

Вы должны увидеть:
- Карту жанров (горизонтальная диаграмма)
- Распределение оценок (pie chart)
- Любимых актеров
- Любимых режиссеров
- **NEW:** Раздел "Ваши близнецы вкуса" (в конце страницы)

### 3. Проверить загрузку компонента

**Если < 5 фильмов в фильмотеке:**
- Компонент не будет показан (нужно минимум 5 для расчета)

**Если есть фильмы:**
- Покажется loader: "Поиск похожих кинозрителей..."
- Затем появится список похожих пользователей (если найдены)
- Каждый пользователь будет показан с:
  - Аватаром (первые 2 буквы ID)
  - Количеством просмотренных фильмов
  - Датой присоединения
  - **% сходства вкуса** (зеленый текст)

### 4. API тест

Прямой запрос к API:

```bash
# Получить 10 похожих пользователей
curl "http://localhost:3000/api/user/similar-users?limit=10"

# Получить 15 без кэша (свежий расчет)
curl "http://localhost:3000/api/user/similar-users?limit=15&useCache=false"
```

**Ожидаемый ответ:**
```json
{
  "similarUsers": [
    {
      "userId": "user_id_123",
      "overallMatch": 78.5,
      "watchCount": 42,
      "memberSince": "2025-06-10T15:30:00Z"
    }
  ],
  "cached": false,
  "computedAt": "2026-02-24T15:35:00Z",
  "message": "Found 3 similar user(s)"
}
```

## Проверка компонентов

### TwinTasters.tsx

Компонент отображает:
- ✅ Спиннер при загрузке
- ✅ Сообщение об ошибке, если API вернула 401/500
- ✅ Сообщение "не найдено", если похожих пользователей нет
- ✅ Список карточек с похожими пользователями
- ✅ Каждая карточка:
  - Аватар (gradient from purple to blue)
  - Имя "Киномана {ID}"
  - Количество фильмов
  - Дата присоединения
  - Процент sходства
  - Иконка like

### Интеграция в page.tsx

```tsx
// src/app/profile/taste-map/page.tsx
<TasteMapClient tasteMap={tasteMap} userId={session.user.id} />

// TasteMapClient содержит:
// ... graphs
// <TwinTasters userId={userId} />  <-- НОВ
```

## Проверка логики

### 1. Минимальная история
- Создать тестовый пользователь с 3 фильмами
- Перейти на `/profile/taste-map`
- **Результат:** Twin Tasters должен скрыться

### 2. Кэширование
- Запрос 1: `useCache=false` - должен вычислить
- Запрос 2: `useCache=true` - должен вернуть из Redis
- Проверить Redis: `redis-cli get "similar-users:userId"`

### 3. Корреляция оценок
- Добавить 2+ общих фильма двем пользователям
- Оценить их по-разному (A: 8, B: 9)
- Вычислить корреляцию → должна быть > 0

### 4. Жанровое сходство
- A смотрит: Комедия, Драма, Триллер
- B смотрит: Комедия, Драма
- Cosine similarity = (1 + 1 + 0) / sqrt(3) * sqrt(2) ≈ 0.82

## Основные файлы

| Файл | Назначение |
|------|-----------|
| `/api/user/similar-users/route.ts` | API эндпоинт |
| `/src/lib/taste-map/similarity.ts` | Алгоритмы вычисления |
| `/src/app/profile/taste-map/TwinTasters.tsx` | UI компонент |
| `/src/app/profile/taste-map/TasteMapClient.tsx` | Интеграция (обновлен) |

## Дебаг информация

В консоли браузера:
```js
// Проверить ответ API
fetch('/api/user/similar-users?limit=5')
  .then(r => r.json())
  .then(d => console.log(d))
```

В логах сервера (смотреть терминал npm):
```
[INFO] Computing similar users userId=... candidatesCount=100
[ERROR] Error computing similarity candidateId=... 
```

## Возможные проблемы

| Проблема | Причина | Решение |
|----------|---------|---------|
| 401 Unauthorized | Не залогинены | Залогинитесь |
| Empty list | < 5 фильмов или нет похожих | Добавьте фильмы |
| 429 Too Many | Rate limit | Подождите |
| Network error | Redis недоступен | Проверьте Redis |

## Итоговая проверка

- [ ] Страница `/profile/taste-map` загружается
- [ ] Twin Tasters компонент показывается (если есть фильмы)
- [ ] API возвращает список похожих пользователей
- [ ] Процент сходства вычисляется правильно
- [ ] Кэширование работает (запрос 2 быстрее)
