# Bug: Несовпадение данных между страницей статистики и страницами детализации

## Дата
2026-02-15

## Описание
На странице "Полная статистика" (profile/stats) значения количества фильмов по рейтингам и жанрам не совпадали с данными на страницах подробной статистики:
- Рейтинг 2 балла: показывало 2 фильма, при переходе - 0
- Рейтинг 3 балла: показывало 8 фильмов, при переходе - 2
- Жанр "Военный": показывало 1 фильм, при переходе - 9

## Причина

### 1. Рейтинги (movies-by-rating)
- `/api/user/stats` (страница stats): использовал статусы `WATCHED, REWATCHED, DROPPED`
- `/api/stats/movies-by-rating` (детализация): использовал только `WATCHED, REWATCHED`

### 2. Жанры (genres)
- `/api/user/genres`: использовал `take: limit` (по умолчанию 50), что обрезало данные
- Данные загружались не полностью
- Статус по умолчанию не включал DROPPED

### 3. Теги (tag-usage)
- Лимит по умолчанию ограничивал количество тегов
- Статус по умолчанию не включал DROPPED

## Решение

### 1. Рейтинги
В `src/app/api/stats/movies-by-rating/route.ts` добавлен `DROPPED` в статусный фильтр:
```typescript
statusId: { in: [MOVIE_STATUS_IDS.WATCHED, MOVIE_STATUS_IDS.REWATCHED, MOVIE_STATUS_IDS.DROPPED] },
```

### 2. Жанры
В `src/app/api/user/genres/route.ts`:
- Убран `take: limit`, чтобы получать все записи
- Добавлен статус по умолчанию с DROPPED
- Исправлен ключ кеша

### 3. Теги
В `src/app/api/user/tag-usage/route.ts`:
- Убран `take: limit`
- Добавлен статус по умолчанию с DROPPED

### 4. movies-by-genre
В `src/app/api/stats/movies-by-genre/route.ts` добавлен DROPPED

### 5. UX Оптимизация
В `src/app/profile/stats/StatsClient.tsx` добавлен прогресс-бар с информативными сообщениями как в Коллекциях:
- Анимированный прогресс-бар
- Сообщения о текущем этапе загрузки
- Timeout 60 секунд для предотвращения зависания

## Предотвращение
При добавлении новых статистических API проверять согласованность статусов между:
- API для сводной страницы (profile/stats)
- API для детализации (/stats/ratings/[rating], /stats/genres/[genre], /stats/tags/[tagId])

Все статистические API должны по умолчанию включать статус DROPPED для полноты данных.
